<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no"/>
  <title>StreamLayer-Static Geometry Use Case</title>
  <link rel="stylesheet" href="https://js.arcgis.com/3.16/esri/css/esri.css">
  <link rel="stylesheet" href="https://js.arcgis.com/3.16/dijit/themes/tundra/tundra.css"/>
  <link rel="shortcut icon" href="../assets/img/favicon.ico">
  <link rel="stylesheet" href="../assets/css/all.css">
  <script src="https://js.arcgis.com/3.16/"></script>
</head>
<body class="tundra">
  <div class="wrapper">
    <div class="drawer drawer-left js-drawer" data-drawer="top-nav">
      <nav class="drawer-nav">
        <aside class="side-nav">
          <h2 class="side-nav-title padding-leader-half padding-trailer-half text-large">Esri Patterns</h2>
          <div class="panel padding-trailer-half padding-leader-half">
            <label class="trailer-0">
              <input type='search' placeholder='Search'>
            </label>
          </div>
          <a href="#" class="side-nav-link padding-trailer-half padding-leader-half">Branding</a>
          <a href="../../../" class="side-nav-link padding-trailer-half padding-leader-half">Web</a></a>
          <a href="#" class="side-nav-link padding-trailer-half padding-leader-half">Mobile</a>
          <a href="#" class="side-nav-link padding-trailer-half padding-leader-half">Presentations</a>
        </aside>
      </nav>
    </div>
    <div class="drawer drawer-right js-drawer" data-drawer="user-nav">
      <nav class="drawer-nav">
        <aside class="side-nav">
          <h2 class="side-nav-title padding-leader-half padding-trailer-half text-large">Sloth Aldrin</h2>
          <a href="#" class="side-nav-link padding-trailer-half padding-leader-half">User Settings</a>
          <a href="#" class="side-nav-link padding-trailer-half padding-leader-half">Logout</a>
        </aside>
      </nav>
    </div>
    <header class="top-nav">
      <a class="skip-to-content" href="#skip-to-content">Skip To Content</a>
      <div class="grid-container">
        <div class="column-24">
          <a href="../index.html" class="top-nav-title tablet-hide">Esri Developer Summit 2016</a>
          <a href="/" class="icon-ui-menu top-nav-title js-drawer-toggle tablet-show" data-drawer="top-nav">Esri Developer Summit 2016</a>
          <!--
          <nav class="top-nav-list left tablet-hide" role="navigation">
            <a href="/features/" class="top-nav-link is-active">Features</a>
            <a href="/plans/" class="top-nav-link">Plans</a>
            <a href="/documentation/" class="top-nav-link">Documentation</a>
            <a href="/community/" class="top-nav-link">Community</a>
          </nav>
          -->
        </div>
      </div>
    </header>
    <header class="sub-nav">
      <div class="grid-container">
        <h1 class="sub-nav-title text-white">Stream Layer: Static Observation Points with Updating Attributes</h1>
        <!--
        <nav id="tabsDiv" class="sub-nav-list">
          <a id="homeTab" class="sub-nav-link is-active" href="#"><span class="icon-ui-flush icon-ui-home"></span></a>
          <a id="dendogramTab" class="sub-nav-link" href="#">Dendrogram + Map</a>
          <a id="cedarTab" class="sub-nav-link" href="#">Cedar Chart + Map</a>
          <a id="adTab" class="sub-nav-link" href="#">Activity Dashboard Chart + Map + Table</a>
          <a id="odTab" class="sub-nav-link" href="#">Open Data Chart + Map + Table</a>
          <a class="sub-nav-link" href="#">Stream Layer Map + Chart</a>
        </nav>
        -->
      </div>
    </header>

    <div class="grid-container">
      <main class="column-24">
        <div class="leader-1">
          <h3 class="text-inline">&nbsp;</h3>
          <button id="cmdToggleStream" class="btn btn-green btn-arrow right">Start Stream</button>
          <button id="cmdSelectMultiBtn" class="btn right margin-right-1 hide">Multiple Select</button>
          <button id="cmdSelectMultiClrBtn" class="btn right margin-right-1 hide">Clear Selection</button>
        </div>

        <div class="leader-0">
          <div id="mapDiv" class="column-24 leader-1"></div>
          <div id="multiChartContainer" class="column-24 leader-1"></div>
        </div>
      </main>
    </div>
  </div>
</body>
<script>
  require([
    "esri/map",
    "esri/layers/StreamLayer",
    "esri/InfoTemplate",
    "esri/toolbars/draw",
    "esri/tasks/query",
    "esri/symbols/SimpleLineSymbol",
    "esri/symbols/SimpleMarkerSymbol",
    "esri/Color",

    "dojo/dom",
    "dojo/dom-class",
    "dojo/dom-construct",
    "dojo/on",
    "dojo/_base/array",
    "dojo/store/Memory",
    "dojo/store/Observable",

    "dojox/charting/Chart",
    "dojox/charting/plot2d/Default",
    "dojox/charting/plot2d/Lines",
    "dojox/charting/StoreSeries",
    "dojox/charting/themes/Claro",
    "dojox/charting/action2d/Tooltip",
    "dojox/charting/axis2d/Default",
    "dojo/domReady!3.x/streamlayer-charts"
    ], function(
      Map, StreamLayer, InfoTemplate, Draw, Query, SimpleLineSymbol, SimpleMarkerSymbol, Color, dom, domClass,
      domConstruct, on, array, Memory, Observable, Chart, Default, Lines, StoreSeries, Theme, Tooltip){

    var url = "http://ec2-75-101-155-202.compute-1.amazonaws.com:6080/arcgis/rest/services/GageStatusRenderer/StreamServer";
    var map,
        streamLayer,
        selectionTool;
    var highlightSymbol = new SimpleMarkerSymbol(SimpleMarkerSymbol.STYLE_SQUARE, 18,
        new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID,
        new Color([255,255,255]), 1),
        new Color([0, 191, 255, 0.75]));
    var storeData = [];
    var memoryStore = new Observable(new Memory({
      data: storeData
    }));

    on(dom.byId("cmdToggleStream"), "click", toggleStreamLayer);
    on(dom.byId("cmdSelectMultiBtn"), "click", handleDrawExtent);
    on(dom.byId("cmdSelectMultiClrBtn"), "click", handleClearSelection);

    map = new Map("mapDiv", {
      basemap: "dark-gray-vector",
      center: [-84.397, 33.766],
      zoom: 8
    });

    function toggleStreamLayer(){
      streamLayer ? disconnectStreamLayer() : connectStreamLayer();
    }

    function connectStreamLayer(){
      var infoTempl = new InfoTemplate("Attributes",
              "Name: ${Name}<br>Station ID: ${StationID}<br>Flood Stage: ${Flood}<br>Current Stage: ${Stage}");
      streamLayer = new StreamLayer(url, {
        purgeOptions: { displayCount: 10000 },
        outFields: ["*"],
        infoTemplate: infoTempl
    });
      map.addLayer(streamLayer);
      streamLayer.setSelectionSymbol(highlightSymbol);
      initSelectionTool(map);

      streamLayer.on("connect", function(){
        dom.byId("cmdToggleStream").innerHTML = "Stop Stream";
        domClass.replace("cmdToggleStream", "btn btn-red btn-arrow right", "btn btn-green btn-arrow right");
        domClass.remove("cmdSelectMultiBtn", "hide");
      });

      streamLayer.on("disconnect", function(){
        dom.byId("cmdToggleStream").innerHTML = "Start Stream";
        domClass.replace("cmdToggleStream", "btn btn-green btn-arrow right", "btn btn-red btn-arrow right");
        domClass.add("cmdSelectMultiBtn", "hide");
      });

      streamLayer.on("error", function(err){
        console.log("error:", err);
      });

      streamLayer.on("click", function(e){
        if(e.graphic.attributes.StationID){
          doHandleSelectedStation(e.graphic.attributes.StationID);
        }
      });

      streamLayer.on("graphic-add", function(graphic){
        memoryStore.put(graphic.graphic.attributes);
      });

      streamLayer.on("message", function(msg){
        memoryStore.put(msg.attributes);
      });
    }

    function doHandleSelectedStation(stationId){
      var chartData = memoryStore.query({StationID:stationId}, {sort: [{attribute: "TimeMS"}]});
      var stationArr = [];
      var chartMeta = {};

      if(chartData.total > 0){
        array.forEach(chartData, function(obj){
          if(obj.Name){
            chartMeta.Name = obj.Name;
            chartMeta.Flood = obj.Flood;
            chartMeta.StationID = obj.StationID;
          }
        });
        stationArr.push(chartMeta);
        handleMakeChart(stationArr);
      }
    }

    function handleMakeChart(stationsArr){
      var divId = "multiChartContainer";
      domConstruct.empty(divId);

      array.forEach(stationsArr, function(station){
        var newDivId = station.StationID;
        domConstruct.place("<div id=" + newDivId + " class='column-8'>", divId, 'last' );
        doGetChart(station, newDivId, function(chartObj){
          chartObj.render();
        });
      })
    }

    function doGetChart(stationData, divId, callback){
      var chart = new Chart(divId, {
        title: stationData.Name,
        titleGap: 5,
        titleFontColor: '#959595',
        titleFont: "normal normal 700 0.75em 'Segoe UI', 'Arial', sans-serif"
      });
      chart.setTheme(Theme);
      chart.addAxis("x", {
        majorTickStep: 1,
        fixUpper: "major",
        minorTicks: false,
        min: 1,
        max: 12,
        includeZero: false
      });
      chart.addAxis("y", {
        vertical: true,
        majorTickStep: 10,
        fixLower: "major",
        fixUpper: "major",
        max: 100,
        min: 0,
        includeZero:true
      });
      chart.addPlot("default", {
        type: Lines,
        markers: true
      });

      var store = new StoreSeries(memoryStore, {query: {StationID: stationData.StationID}}, "Stage");
      chart.addSeries("x", store, "Stage");

      new Tooltip(chart, "default", {
        text: function (e) {
          var html;
          html = '<h4>Reported Value: ' + e.run.data[e.index] + ' </h4>';
          return html;
        }
      });
      callback(chart);
    }

    function handleDrawExtent(e){
      selectionTool.activate(Draw.EXTENT);
    }

    function initSelectionTool(mapObj){
      selectionTool = new Draw(mapObj);
      on(selectionTool, "DrawEnd", handleDrawEnd);
    }

    function handleDrawEnd(geometry){
      //console.log(e);
      var selectQuery, selectedFeatures, selObjects;
      var multiStationArr = [];
      selectQuery = new Query();
      selectionTool.deactivate();
      selectQuery.geometry = geometry;
      selectedFeatures = streamLayer.selectFeatures(selectQuery, StreamLayer.SELECTION_NEW);

      if(selectedFeatures.results[0][0].length > 0){
        selObjects = selectedFeatures.results[0][0];
        array.forEach(selObjects, function(station){
          multiStationArr.push(station.attributes);
        });
        domClass.remove("cmdSelectMultiClrBtn", "hide");
        handleMakeChart(multiStationArr);
      }
    }

    function handleClearSelection(){
      streamLayer.clearSelection();
    }

    function disconnectStreamLayer(){
      if (streamLayer){
        map.removeLayer(streamLayer);
        streamLayer = null;
      }
    }


  });
</script>
</html>
